name: Deploy to Alwaysdata via FTP

on:
  push:
    branches: [ main ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --no-progress --no-suggest --optimize-autoloader

      # Build frontend assets (Node)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install and build frontend assets
        run: |
          npm ci
          npm run build

      - name: Resolve and test SSH host from runner
        run: |
          HOST="${{ secrets.SSH_HOST }}"
          PORT="${{ secrets.SSH_PORT }}"
          echo "Resolving $HOST"
          getent hosts "$HOST" || nslookup "$HOST" || host "$HOST" || true
          echo "Testing TCP/$PORT"
          timeout 5 bash -c "</dev/tcp/$HOST/$PORT" && echo "TCP open on $PORT" || echo "TCP closed or filtered on $PORT"
        shell: bash

      - name: Test SSH connectivity (debug, non-blocking)
        uses: appleboy/ssh-action@v0.1.8
        continue-on-error: true
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "SSH test start"
            uname -a || true
            id || true
            echo "SSH test end"

      - name: Upload files via SCP
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "./"
          target: ${{ secrets.FTP_TARGET_DIR }}
          strip_components: 1
          overwrite: true


      - name: Run post-deploy commands via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd ${{ secrets.FTP_TARGET_DIR }}
            if [ -f composer.json ]; then composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader; fi
            php artisan migrate --force || true
            php artisan storage:link || true
            php artisan config:cache || true

      - name: Done
        run: echo "Deployment finished. Check Alwaysdata and logs for post-deploy tasks."